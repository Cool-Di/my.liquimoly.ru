var LM=LM||{};LM.OilApi={};LM.OilApi.Widget=(function(){var i,g=document,d=XMLHttpRequest,c="/lmoilapiajax.php",a="Oil Api - Liqui Moly",h="html",e="widget",b=["search","categories","makes","models","types","recommendations"];var f=function(j,k){if(!(this instanceof f)){return new f(j,k)}if(i){return i}i=this;this.listener=null;this.dev=k;this.url=this.dev?c:j+c;this.container=g.querySelector('[data-view*="'+e+'"]');if(this.container===null){this.addHtml(g.body,{error:"Не найден контейнер виджета с тегом `data-view`!"});return}this.view=this.container.getAttribute("data-view");this.clid=this.container.getAttribute("data-clid");this.prefix=this.view.replace(e,"");this.choicediv=g.querySelector('[data-choice="'+this.prefix+'choice"]');this.multi=false;this.init()};f.prototype.init=function(){this.getData([0,1])};f.prototype.getNameComponent=function(j){if(typeof j=="number"){if(j in b){return this.prefix+b[j]}else{return"none"}}if(typeof j=="string"){return this.prefix+j}};f.prototype.getIndexComponent=function(j){j=j.replace(this.prefix,"");return b.indexOf(j)};f.prototype.findDataElement=function(n,l,m){if((typeof n==="object")&&("querySelector" in n)){var j=(m)?m:l;return n.querySelector("[data-"+j+'="'+this.prefix+l+'"]')}};f.prototype.findElementByName=function(k,j){if((typeof k==="object")&&("querySelector" in k)){return k.querySelector('[name="'+j+'"]')}};f.prototype.getNextOperation=function(j){return(j===0)?4:(j+1)};f.prototype.addHtml=function(j,n){var o,m,l=["error","message","dump"];for(var k in n){if(l.indexOf(k)>=0&&n[k]){m=k;break}}if(m!==undefined){o=g.createElement("div");o.setAttribute("data-"+m,this.prefix+m);o.setAttribute("style","color:#ff0000");o.innerHTML=a+": "+n[m];if((typeof j==="object")&&("appendChild" in j)){j.appendChild(o)}}};f.prototype.deleteHtml=function(j,k){var l;if(Array.isArray(j)){j.forEach(function(m){l=this.findDataElement(k,m);if(l instanceof HTMLElement){if(l.parentNode){l.parentNode.removeChild(l)}}},this)}};f.prototype.addHtmlContent=function(k,l){var j=(this.choicediv===null)?this.container:this.choicediv;j.insertAdjacentHTML("beforeend",l);if(this.choicediv===null){this.choicediv=g.querySelector('[data-choice*="'+this.prefix+'choice"]');this.listener=this.widgetEvent.bind(this);this.addHandler(this.choicediv,"click",this.listener);this.addHandler(this.choicediv,"change",this.listener);this.addHandler(this.choicediv,"keyup",this.listener)}return this.container.querySelector('[data-step="'+this.getNameComponent(k)+'"]')};f.prototype.refreshChoice=function(j){this.deleteHtml(["error","message","dump"],this.container);this.deleteComponent(j)};f.prototype.validateComponentData=function(k){switch(k.tagName){case"INPUT":var j=k.value.replace(/\s/g,"");return(j.length!==0);case"SELECT":return(k.selectedIndex!==0)}};f.prototype.getData=function(k){var l,j,m;this.multi=Array.isArray(k);if(this.multi){m=k.map(function(n){return this.getRequestData(n)},this)}else{m=this.getRequestData(k);this.refreshChoice(k)}l=this.getData.getKey(m);j=this.getData.cache[l];if(!j){this.changeBlockStatus(true,false);this.getAjaxData(m,this.url,k)}else{this.updateContainer(k,j)}return this};f.prototype.getData.cache={};f.prototype.getData.getKey=function(k){var j="",l=(Array.isArray(k))?k:[k];l.forEach(function(m){j+=m.operation+m.id+m.text});return JSON.stringify(j)};f.prototype.getData.addCacheData=function(k,l){var j=f.prototype.getData.getKey(k);f.prototype.getData.cache[j]=l};f.prototype.getAjaxData=function(p,m,l){var k=this,j,q=new d();q.open("POST",m,true);q.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");q.onload=function(){if(q.status===200){o(q.responseText)}else{var r=new Error(q.statusText+" "+q.status);n(r)}};q.onerror=function(){n(new Error("Ошибка сети"))};j="data="+JSON.stringify(p);q.send(j);var o=function(r){var t,v,s=/\[\{"data[\W\w]*"\}\]/;try{t=s.exec(r);v=r.replace(t,"");r=JSON.parse(t);if(k.multi&&(r.length>1)){k.multiUpdateContainer(l,r)}else{k.updateContainer(l,r[0]);k.getData.addCacheData(p,r[0])}}catch(u){k.updateContainer(0,r)}if((v.length!==0)&&(k.dev)){k.addHtml(k.container,{dump:v})}k.changeBlockStatus(false)};var n=function(r){k.addHtml(k.container,{error:r});k.changeBlockStatus(false)}};f.prototype.getRequestData=function(j){var l,k=j;if(j>0){l=this.container.querySelector('[name="'+this.getNameComponent(j)+'"]');k=(l===null)?j:j+1}return{clid:this.clid,format:h,prefix:this.prefix,operation:b[k],id:this.getStepParameter("id",(j===0)?1:j),text:(j>0)?"":this.getStepParameter("value",j)}};f.prototype.getStepParameter=function(l,k){var m,j=this.getNameComponent(k);m=g.getElementsByName(j)[0];if((m===undefined)||(m===null)){return""}return(k===0)?m.value:m.options[m.selectedIndex].id};f.prototype.multiUpdateContainer=function(j,k){j.forEach(function(l){this.updateContainer(l,k[l])},this)};f.prototype.updateContainer=function(k,m){var l,j=this.container.querySelector('[data-step="'+this.getNameComponent(k)+'"]');if(m.error!==""){this.refreshChoice(0);this.addHtml(this.container,m);return}if(m.message!==""){this.addHtml(this.choicediv,m);return}l=(j===null)?k:this.getNextOperation(k);this.addComponent(l,m.data)};f.prototype.addComponent=function(j,l){var k=this.addHtmlContent(j,l);if((k!==null)&&(j===(b.length-1))){this.changeVisibleAllSection(false,1)}};f.prototype.deleteComponent=function(k){var m,j,l=this.container.querySelector('[data-step="'+this.getNameComponent(k)+'"]');if(l===null){return}m=this.choicediv.querySelectorAll("div[data-step]");j=m.length;if(k===0){k=1}if((k===4)&&(j<=k)){k=2}if(l!==null){if((j-1)>k){while((k+1)<j){j-=1;this.choicediv.removeChild(m[j])}}}};f.prototype.resetComponent=function(j){var k=this.findElementByName(this.container,this.getNameComponent(j));if(k instanceof HTMLElement){switch(k.tagName){case"INPUT":k.value="";break;case"SELECT":k.selectedIndex=0;break}}return this};f.prototype.updateSearchLabel=function(k){var j=this.findDataElement(this.container,"search","step").firstElementChild;if(j instanceof HTMLElement){j.innerText="Поиск: "+k}};f.prototype.changeBlockStatus=function(j,k){var m=this.findDataElement(this.container,"block");if(m instanceof HTMLElement){m.style.visibility=(j)?"visible":"hidden"}if(!k){var l=this.container.querySelectorAll('[name*="'+this.prefix+'"]');if(Array.isArray(l)){[].forEach.call(l,function(o,n,p){if(j){p[n].setAttribute("disabled","disabled")}else{p[n].removeAttribute("disabled")}})}}};f.prototype.addHandler=function(k,j,l){k.addEventListener(j,l,false)};f.prototype.removeHandler=function(k,j,l){k.removeEventListener(j,l)};f.prototype.widgetEvent=function(k){var j;switch(k.target.tagName){case"INPUT":if(k.type==="keyup"){if(k.keyCode!==13){return}this.keyUpEvent(k.target)}break;case"SELECT":if(k.type==="change"){this.changeEvent(k.target)}break;case"BUTTON":if(k.type==="click"){j=this.findElementByName(this.container,this.getNameComponent("search"));this.keyUpEvent(j)}break;case"SPAN":j=k.target.parentElement;if(j.getAttribute("data-component")){this.changeVisibleSection(j)}if(k.target.getAttribute("data-init")){this.resetEvent()}if(k.target.getAttribute("data-updown")){this.expandEvent(k.target)}break}};f.prototype.changeEvent=function(k){var l,j=this.getIndexComponent(k.name);if(j===1){this.resetComponent("search");this.updateSearchLabel(k.value)}l=this.validateComponentData(k);(l)?this.getData(j):this.deleteComponent(j)};f.prototype.keyUpEvent=function(j){var k=this.validateComponentData(j);(k)?this.getData(this.getIndexComponent(j.name)):this.deleteComponent(1)};f.prototype.reInitEvent=function(){this.removeHandler(this.choicediv,"click",this.listener);this.removeHandler(this.choicediv,"change",this.listener);this.removeHandler(this.choicediv,"keyup",this.listener);this.container.innerHTML="";this.choicediv=null;this.init()};f.prototype.resetEvent=function(){this.deleteComponent(1);this.resetComponent("search").resetComponent("categories");this.updateSearchLabel("")};f.prototype.expandEvent=function(j){this.changeStatusExpanded(j);this.changeVisibleAllSection(!j.colexp)};f.prototype.changeStatusExpanded=function(j){j.colexp=!j.colexp;j.innerText=(j.colexp)?"Развернуть всё":"Свернуть всё"};f.prototype.changeVisibleAllSection=function(l,k,o){var m=this.container.querySelectorAll('[data-component="component"]');for(var n=((k!==undefined)?k:0),j=(o===undefined)?m.length:o;n<j;n+=1){this.changeVisibleSection(m[n],l)}};f.prototype.changeVisibleSection=function(m,j){var l,o=m.lastElementChild,k=m.querySelector('[data-arrow="arrow"]'),n=function(p){p.innerText=(p.innerText==="\u25BA")?"\u25BC":"\u25BA"};j=(typeof j==="boolean")?j:((o.style.display==="none")?true:false);l=(j)?"block":"none";if(o.style.display!==l){o.style.display=l;n(k)}};return f}());